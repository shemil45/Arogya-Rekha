<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Profile - Arogya Rekha</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="health-id.css">
  
  <style>
    /* Dark Theme Styles */
    [data-theme="dark"] {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-card: #3a3a3a;
      --text-primary: #ffffff;
      --text-secondary: #b0b0b0;
      --border-color: #4a4a4a;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
    }
    
    [data-theme="dark"] body {
      background-color: var(--bg-primary);
      color: var(--text-primary);
    }
    
    [data-theme="dark"] .profile-card {
      background: linear-gradient(135deg, #2d2d2d 0%, #3a3a3a 100%);
      border: 2px solid var(--border-color);
    }
    
    [data-theme="dark"] .form-control {
      background-color: var(--bg-secondary);
      border-color: var(--border-color);
      color: var(--text-primary);
    }
    
    [data-theme="dark"] .form-control:focus {
      background-color: var(--bg-secondary);
      border-color: #4dabf7;
      color: var(--text-primary);
      box-shadow: 0 0 0 0.2rem rgba(77, 171, 247, 0.25);
    }
    
    [data-theme="dark"] .form-select {
      background-color: var(--bg-secondary);
      border-color: var(--border-color);
      color: var(--text-primary);
    }

    [data-theme="dark"] .form-control[readonly] {
      background-color: var(--bg-secondary);
      border-color: var(--border-color);
      color: var(--text-secondary);
    }

    [data-theme="dark"] .form-select:disabled {
      background-color: var(--bg-secondary);
      border-color: var(--border-color);
      color: var(--text-secondary);
    }
    
    [data-theme="dark"] .text-muted {
      color: var(--text-secondary) !important;
    }
    
    [data-theme="dark"] .btn-outline-secondary {
      color: var(--text-secondary);
      border-color: var(--border-color);
    }
    
    [data-theme="dark"] .btn-outline-secondary:hover {
      background-color: var(--border-color);
      color: var(--text-primary);
    }
    
    /* Light Theme (Default) */
    [data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-card: #ffffff;
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --border-color: #dee2e6;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .profile-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .profile-header {
      background: linear-gradient(135deg, #1B4F72 0%, #2E86AB 100%);
      color: white;
      padding: 2rem;
      border-radius: 15px 15px 0 0;
      text-align: center;
    }

    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 4px solid white;
      margin: 0 auto 1rem;
      background: #f8f9fa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: #1B4F72;
    }

    .profile-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }

    .profile-card {
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .profile-content {
      padding: 2rem;
    }

    .section-title {
      color: #1B4F72;
      font-weight: 600;
      margin-bottom: 1.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e9ecef;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid #f8f9fa;
    }

    .info-item:last-child {
      border-bottom: none;
    }

    .info-label {
      font-weight: 500;
      color: #6c757d;
      font-size: 1rem;
    }

    .info-value {
      font-weight: 600;
      color: #212529;
      font-size: 1rem;
    }

    .edit-btn {
      background: none;
      border: none;
      color: #1B4F72;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .edit-btn:hover {
      background-color: #f8f9fa;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .stat-card {
      background: #f8f9fa;
      padding: 1.5rem;
      border-radius: 10px;
      text-align: center;
      border: 1px solid #e9ecef;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: #1B4F72;
    }

    .stat-label {
      color: #6c757d;
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      flex-wrap: wrap;
    }

    .btn-custom {
      flex: 1;
      min-width: 150px;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn-custom:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .modal-content {
      border-radius: 15px;
      border: none;
    }

    .modal-header {
      background: linear-gradient(135deg, #1B4F72 0%, #2E86AB 100%);
      color: white;
      border-radius: 15px 15px 0 0;
    }

    .form-floating {
      margin-bottom: 1rem;
    }

    .form-floating .form-control {
      border-radius: 8px;
    }

    .form-floating .form-control[readonly] {
      background-color: #f8f9fa;
      border-color: #e9ecef;
      color: #6c757d;
    }

    .form-floating .form-select:disabled {
      background-color: #f8f9fa;
      border-color: #e9ecef;
      color: #6c757d;
    }

    .form-floating label {
      color: #6c757d;
    }

    .photo-upload {
      text-align: center;
      padding: 2rem;
      border: 2px dashed #dee2e6;
      border-radius: 10px;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .photo-upload:hover {
      border-color: #1B4F72;
      background-color: #f8f9fa;
    }

    .photo-upload.dragover {
      border-color: #1B4F72;
      background-color: #e3f2fd;
    }

    .emergency-section {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 10px;
      padding: 1.5rem;
      margin: 1.5rem 0;
    }

    .emergency-section h6 {
      color: #856404;
      font-weight: 600;
    }

    .emergency-contact {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: #856404;
      font-weight: 500;
      font-size: 1rem;
    }

    @media (max-width: 768px) {
      .profile-content {
        padding: 1rem;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn-custom {
        min-width: auto;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <a href="./health-id.html" class="back-btn">
          <i class="fas fa-arrow-left"></i>
        </a>
        <div class="header-title">
          <h1>My Profile</h1>
          <p>Manage your health information</p>
        </div>
      </div>
      <div class="header-right">
        <button id="logoutBtn" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="container py-4">
    <div class="profile-container">
      <!-- Profile Card -->
      <div class="profile-card">
        <!-- Profile Header -->
        <div class="profile-header">
          <div class="profile-avatar" id="profileAvatar">
            <i class="fas fa-user"></i>
          </div>
          <h3 id="profileName">Loading...</h3>
          <p class="mb-0" id="profileHealthId">Health ID: Loading...</p>
        </div>

        <!-- Profile Content -->
        <div class="profile-content">
          <!-- Quick Stats -->
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="totalVisits">0</div>
              <div class="stat-label">Total Visits</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="lastVisit">-</div>
              <div class="stat-label">Last Visit</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="activeMedications">0</div>
              <div class="stat-label">Active Medications</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="allergies">0</div>
              <div class="stat-label">Allergies</div>
            </div>
          </div>

          <!-- Personal Information -->
          <h5 class="section-title">
            <i class="fas fa-user me-2"></i>Personal Information
          </h5>
          <div class="row">
            <div class="col-md-6">
              <div class="info-item">
                <span class="info-label">Full Name</span>
                <div>
                  <span class="info-value" id="fullName">-</span>
                </div>
              </div>
              <div class="info-item">
                <span class="info-label">Date of Birth</span>
                <div>
                  <span class="info-value" id="dateOfBirth">-</span>
                </div>
              </div>
              <div class="info-item">
                <span class="info-label">Gender</span>
                <div>
                  <span class="info-value" id="gender">-</span>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-item">
                <span class="info-label">Blood Group</span>
                <div>
                  <span class="info-value" id="bloodGroup">-</span>
                </div>
              </div>
              <div class="info-item">
                <span class="info-label">Home State</span>
                <div>
                  <span class="info-value" id="homeState">-</span>
                </div>
              </div>
              <div class="info-item">
                <span class="info-label">Phone Number</span>
                <div>
                  <span class="info-value" id="phoneNumber">-</span>
                </div>
              </div>
              <div class="info-item">
                <span class="info-label">Field of Work</span>
                <div>
                  <span class="info-value" id="fieldOfWork">-</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Emergency Contact -->
          <div class="emergency-section">
            <h6><i class="fas fa-exclamation-triangle me-2"></i>Emergency Contact</h6>
            <div class="emergency-contact">
              <i class="fas fa-phone"></i>
              <span id="emergencyContact">Not set</span>
              <button class="edit-btn ms-auto" onclick="editField('emergencyContact')">
                <i class="fas fa-edit"></i>
              </button>
            </div>
          </div>

          <!-- Medical Information -->
          <h5 class="section-title">
            <i class="fas fa-heartbeat me-2"></i>Medical Information
          </h5>
          <div class="row">
            <div class="col-md-6">
              <div class="info-item">
                <span class="info-label">Allergies</span>
                <div>
                  <span class="info-value" id="allergiesList">None recorded</span>
                  <button class="edit-btn" onclick="editField('allergiesList')">
                    <i class="fas fa-edit"></i>
                  </button>
                </div>
              </div>
              <div class="info-item">
                <span class="info-label">Chronic Conditions</span>
                <div>
                  <span class="info-value" id="chronicConditions">None recorded</span>
                  <button class="edit-btn" onclick="editField('chronicConditions')">
                    <i class="fas fa-edit"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-item">
                <span class="info-label">Current Medications</span>
                <div>
                  <span class="info-value" id="currentMedications">None recorded</span>
                  <button class="edit-btn" onclick="editField('currentMedications')">
                    <i class="fas fa-edit"></i>
                  </button>
                </div>
              </div>
              <div class="info-item">
                <span class="info-label">Last Health Check</span>
                <div>
                  <span class="info-value" id="lastHealthCheck">Not recorded</span>
                  <button class="edit-btn" onclick="editField('lastHealthCheck')">
                    <i class="fas fa-edit"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-item">
                <span class="info-label">Recommended Specialist</span>
                <div>
                  <span class="info-value" id="recommendedSpecialist">-</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="action-buttons">
            <button class="btn btn-primary btn-custom" onclick="openEditModal()">
              <i class="fas fa-edit me-2"></i>Edit Profile
            </button>
            <button class="btn btn-success btn-custom" onclick="downloadHealthReport()">
              <i class="fas fa-download me-2"></i>Download Health Report
            </button>
            <button class="btn btn-info btn-custom" onclick="shareProfile()">
              <i class="fas fa-share me-2"></i>Share Profile
            </button>
            <button class="btn btn-warning btn-custom" onclick="viewHealthHistory()">
              <i class="fas fa-history me-2"></i>Health History
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editProfileModalLabel">
            <i class="fas fa-user-edit me-2"></i>Edit Profile
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="editProfileForm">
            <!-- Photo Upload -->
            <div class="photo-upload" onclick="document.getElementById('photoInput').click()">
              <i class="fas fa-camera fa-3x text-muted mb-3"></i>
              <p class="mb-0">Click to upload or change profile photo</p>
              <small class="text-muted">JPG, PNG up to 5MB</small>
            </div>
            <input type="file" id="photoInput" accept="image/*" style="display: none;" onchange="handlePhotoUpload(event)">

            <!-- Read-only fields (display only) -->
            <div class="row">
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="editFullName" placeholder="Full Name" readonly>
                  <label for="editFullName">Full Name (Read-only)</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="date" class="form-control" id="editDateOfBirth" placeholder="Date of Birth" readonly>
                  <label for="editDateOfBirth">Date of Birth (Read-only)</label>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <select class="form-select" id="editGender" disabled>
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="Other">Other</option>
                  </select>
                  <label for="editGender">Gender (Read-only)</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <select class="form-select" id="editBloodGroup" disabled>
                    <option value="">Select Blood Group</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                  </select>
                  <label for="editBloodGroup">Blood Group (Read-only)</label>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="text" class="form-control" id="editHomeState" placeholder="Home State" readonly>
                  <label for="editHomeState">Home State (Read-only)</label>
                </div>
              </div>
              <div class="col-md-6">
                <div class="form-floating mb-3">
                  <input type="tel" class="form-control" id="editPhoneNumber" placeholder="Phone Number">
                  <label for="editPhoneNumber">Phone Number</label>
                </div>
              </div>
            </div>

            <div class="form-floating mb-3">
              <input type="tel" class="form-control" id="editEmergencyContact" placeholder="Emergency Contact">
              <label for="editEmergencyContact">Emergency Contact Number</label>
            </div>

            <div class="form-floating mb-3">
              <select class="form-select" id="editFieldOfWork">
                <option value="">Select Field of Work</option>
                <option value="Construction Worker">Construction Worker</option>
                <option value="Factory Worker">Factory Worker</option>
                <option value="Agricultural Worker">Agricultural Worker</option>
                <option value="Domestic Worker">Domestic Worker</option>
                <option value="Textile Worker">Textile Worker</option>
                <option value="Mason">Mason</option>
                <option value="Painter">Painter</option>
                <option value="Electrician">Electrician</option>
                <option value="Plumber">Plumber</option>
                <option value="Driver">Driver</option>
                <option value="Security Guard">Security Guard</option>
                <option value="Cleaner">Cleaner</option>
                <option value="Cook">Cook</option>
                <option value="Gardener">Gardener</option>
                <option value="Laborer">Laborer</option>
                <option value="Other">Other</option>
              </select>
              <label for="editFieldOfWork">Field of Work</label>
            </div>

            <div class="form-floating mb-3">
              <textarea class="form-control" id="editAllergies" placeholder="Allergies" style="height: 100px"></textarea>
              <label for="editAllergies">Allergies (if any)</label>
            </div>

            <div class="form-floating mb-3">
              <textarea class="form-control" id="editChronicConditions" placeholder="Chronic Conditions" style="height: 100px"></textarea>
              <label for="editChronicConditions">Chronic Conditions</label>
            </div>

            <div class="form-floating mb-3">
              <textarea class="form-control" id="editCurrentMedications" placeholder="Current Medications" style="height: 100px"></textarea>
              <label for="editCurrentMedications">Current Medications</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="saveProfile()" id="saveProfileBtn">
            <i class="fas fa-save me-2"></i>Save Changes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="app-toast" role="status" aria-live="polite"></div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Custom JS -->
  <script src="../../js/data.js"></script>
  <script src="../../js/main.js"></script>
  
  <script>
    let currentUser = null;
    let editModal = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Profile page initialized');
      
      // Initialize UserManager to ensure data is loaded
      if (typeof UserManager !== 'undefined') {
        UserManager.initMockUsers();
        console.log('UserManager initialized');
      }
      
      initializeProfile();
      
      // Initialize modal
      const modalElement = document.getElementById('editProfileModal');
      if (modalElement) {
        editModal = new bootstrap.Modal(modalElement);
        console.log('Edit modal initialized');
      } else {
        console.error('Edit modal element not found');
      }
      
      // Add event listener for save button as backup
      const saveBtn = document.getElementById('saveProfileBtn');
      if (saveBtn) {
        saveBtn.addEventListener('click', function(e) {
          e.preventDefault();
          console.log('Save button clicked via event listener');
          saveProfile();
        });
        console.log('Save button event listener added');
      } else {
        console.error('Save button not found');
      }
      
      // Logout functionality
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          if (confirm('Are you sure you want to logout?')) {
            try {
              if (typeof UserManager !== 'undefined') {
                UserManager.clearCurrentUser();
              }
              if (typeof App !== 'undefined') {
                localStorage.removeItem(App.STORAGE_KEYS.selectedWorkerId);
              }
              App.showToast('Logged out successfully');
              setTimeout(() => {
                window.location.href = '../../index.html';
              }, 1000);
            } catch (error) {
              console.error('Logout error:', error);
              window.location.href = '../../index.html';
            }
          }
        });
      }
    });

    // Initialize profile data
    function initializeProfile() {
      // Get current user data
      currentUser = UserManager.getCurrentUser();
      const selectedWorkerId = App.getSelectedWorker();
      const worker = currentUser || (selectedWorkerId ? App.findWorkerById(selectedWorkerId) : null);
      
      console.log('Current user:', currentUser);
      console.log('Selected worker ID:', selectedWorkerId);
      console.log('Worker data:', worker);
      
      if (!worker) {
        App.showToast('No user data found', 'error');
        setTimeout(() => {
          window.location.href = './register.html';
        }, 2000);
        return;
      }

      // Populate profile data
      populateProfile(worker);
    }

    // Populate profile with user data
    function populateProfile(worker) {
      // Basic info
      document.getElementById('profileName').textContent = worker.name || 'Unknown User';
      document.getElementById('profileHealthId').textContent = `Health ID: ${worker.healthId || 'Not assigned'}`;
      document.getElementById('fullName').textContent = worker.name || '-';
      document.getElementById('dateOfBirth').textContent = worker.dob ? formatDate(worker.dob) : '-';
      document.getElementById('gender').textContent = worker.gender || '-';
      document.getElementById('bloodGroup').textContent = worker.bloodGroup || '-';
      document.getElementById('homeState').textContent = worker.homeState || '-';
      document.getElementById('phoneNumber').textContent = worker.phone || '-';
      
      // Debug field of work
      console.log('Worker field of work:', worker.fieldOfWork);
      
      // Set field of work with fallback
      let fieldOfWork = worker.fieldOfWork;
      if (!fieldOfWork) {
        // Fallback based on health ID
        const fieldOfWorkMap = {
          "MW123456": "Construction Worker",
          "MW234567": "Factory Worker", 
          "MW345678": "Agricultural Worker",
          "MW456789": "Domestic Worker",
          "MW567890": "Textile Worker"
        };
        fieldOfWork = fieldOfWorkMap[worker.healthId] || 'Not specified';
        
        // Update the worker object
        worker.fieldOfWork = fieldOfWork;
        if (typeof UserManager !== 'undefined') {
          UserManager.updateCurrentUser(worker);
        }
      }
      
      document.getElementById('fieldOfWork').textContent = fieldOfWork;
      document.getElementById('emergencyContact').textContent = worker.emergencyContact || 'Not set';

      // Medical info
      document.getElementById('allergiesList').textContent = worker.allergies || 'None recorded';
      document.getElementById('chronicConditions').textContent = worker.chronicConditions || 'None recorded';
      document.getElementById('currentMedications').textContent = worker.medications || 'None recorded';
      document.getElementById('lastHealthCheck').textContent = worker.lastHealthCheck || 'Not recorded';
      
      // Recommended specialist based on field of work
      document.getElementById('recommendedSpecialist').textContent = getRecommendedSpecialist(worker.fieldOfWork);

      // Stats (mock data for demo)
      document.getElementById('totalVisits').textContent = worker.totalVisits || '0';
      document.getElementById('lastVisit').textContent = worker.lastVisit || '-';
      document.getElementById('activeMedications').textContent = worker.medications ? worker.medications.split(',').length : '0';
      document.getElementById('allergies').textContent = worker.allergies ? worker.allergies.split(',').length : '0';

      // Profile photo
      if (worker.photo) {
        const avatar = document.getElementById('profileAvatar');
        avatar.innerHTML = `<img src="${worker.photo}" alt="Profile Photo">`;
      }
    }

    // Format date
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-IN');
    }

    // Get recommended specialist based on field of work
    function getRecommendedSpecialist(fieldOfWork) {
      if (!fieldOfWork) return 'Not specified';
      
      const specialistMap = {
        'Construction Worker': 'Orthopedist (for musculoskeletal issues)',
        'Factory Worker': 'Occupational Medicine Specialist',
        'Agricultural Worker': 'General Physician (for pesticide exposure)',
        'Domestic Worker': 'General Physician',
        'Textile Worker': 'Pulmonologist (for respiratory issues)',
        'Mason': 'Orthopedist (for back and joint problems)',
        'Painter': 'Pulmonologist (for chemical exposure)',
        'Electrician': 'General Physician (for electrical safety)',
        'Plumber': 'General Physician',
        'Driver': 'General Physician (for stress-related issues)',
        'Security Guard': 'General Physician',
        'Cleaner': 'Dermatologist (for skin issues)',
        'Cook': 'General Physician',
        'Gardener': 'Dermatologist (for skin allergies)',
        'Laborer': 'Orthopedist (for physical strain)'
      };
      
      return specialistMap[fieldOfWork] || 'General Physician';
    }

    // Open edit modal
    function openEditModal() {
      if (!currentUser) return;

      // Populate form with current data
      document.getElementById('editFullName').value = currentUser.name || '';
      document.getElementById('editDateOfBirth').value = currentUser.dob || '';
      
      // Temporarily enable disabled fields to set values
      const genderField = document.getElementById('editGender');
      const bloodGroupField = document.getElementById('editBloodGroup');
      
      genderField.disabled = false;
      bloodGroupField.disabled = false;
      
      genderField.value = currentUser.gender || '';
      bloodGroupField.value = currentUser.bloodGroup || '';
      
      // Re-disable the fields
      genderField.disabled = true;
      bloodGroupField.disabled = true;
      
      document.getElementById('editHomeState').value = currentUser.homeState || '';
      document.getElementById('editPhoneNumber').value = currentUser.phone || '';
      document.getElementById('editEmergencyContact').value = currentUser.emergencyContact || '';
      document.getElementById('editFieldOfWork').value = currentUser.fieldOfWork || '';
      document.getElementById('editAllergies').value = currentUser.allergies || '';
      document.getElementById('editChronicConditions').value = currentUser.chronicConditions || '';
      document.getElementById('editCurrentMedications').value = currentUser.medications || '';

      editModal.show();
    }

    // Save profile changes
    function saveProfile() {
      console.log('Save profile function called');
      
      if (!currentUser) {
        console.error('No current user found');
        App.showToast('No user data found', 'error');
        return;
      }

      try {
        // Get only editable form data (exclude read-only fields)
        const formData = {
          phone: document.getElementById('editPhoneNumber').value,
          emergencyContact: document.getElementById('editEmergencyContact').value,
          fieldOfWork: document.getElementById('editFieldOfWork').value,
          allergies: document.getElementById('editAllergies').value,
          chronicConditions: document.getElementById('editChronicConditions').value,
          medications: document.getElementById('editCurrentMedications').value
        };

        console.log('Form data to save:', formData);

        // Update current user data with only editable fields
        Object.assign(currentUser, formData);

        // Save to storage using UserManager
        if (typeof UserManager !== 'undefined') {
          UserManager.updateCurrentUser(currentUser);
          
          // Also update in the main users array
          const allUsers = UserManager.getAllUsers();
          const userIndex = allUsers.findIndex(user => user.healthId === currentUser.healthId);
          if (userIndex !== -1) {
            allUsers[userIndex] = { ...allUsers[userIndex], ...formData };
            localStorage.setItem(UserManager.STORAGE_KEYS.users, JSON.stringify(allUsers));
            console.log('Updated user in main users array');
          }
          
          // Update workers array for compatibility
          const allWorkers = JSON.parse(localStorage.getItem(UserManager.STORAGE_KEYS.workers) || '[]');
          const workerIndex = allWorkers.findIndex(worker => worker.healthId === currentUser.healthId);
          if (workerIndex !== -1) {
            allWorkers[workerIndex] = { ...allWorkers[workerIndex], ...formData };
            localStorage.setItem(UserManager.STORAGE_KEYS.workers, JSON.stringify(allWorkers));
            console.log('Updated user in workers array');
          }
        } else {
          console.error('UserManager not found');
        }

        // Update display
        populateProfile(currentUser);

        // Close modal
        if (editModal) {
          editModal.hide();
        }

        // Show success message
        if (typeof App !== 'undefined' && App.showToast) {
          App.showToast('Profile updated successfully');
        } else {
          alert('Profile updated successfully');
        }
        
        console.log('Profile saved successfully:', currentUser);
        
      } catch (error) {
        console.error('Error saving profile:', error);
        if (typeof App !== 'undefined' && App.showToast) {
          App.showToast('Error saving profile', 'error');
        } else {
          alert('Error saving profile: ' + error.message);
        }
      }
    }

    // Handle photo upload
    function handlePhotoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        App.showToast('Please select an image file', 'error');
        return;
      }

      // Validate file size (5MB limit)
      if (file.size > 5 * 1024 * 1024) {
        App.showToast('File size must be less than 5MB', 'error');
        return;
      }

      // Convert to base64 and update
      const reader = new FileReader();
      reader.onload = function(e) {
        if (currentUser) {
          currentUser.photo = e.target.result;
          if (typeof UserManager !== 'undefined') {
            UserManager.updateCurrentUser(currentUser);
          }
          populateProfile(currentUser);
          App.showToast('Profile photo updated');
        }
      };
      reader.readAsDataURL(file);
    }

    // Edit individual field
    function editField(fieldName) {
      const currentValue = document.getElementById(fieldName).textContent;
      const newValue = prompt(`Edit ${fieldName.replace(/([A-Z])/g, ' $1').toLowerCase()}:`, currentValue);
      
      if (newValue !== null && newValue !== currentValue) {
        if (currentUser) {
          currentUser[fieldName] = newValue;
          if (typeof UserManager !== 'undefined') {
            UserManager.updateCurrentUser(currentUser);
          }
          populateProfile(currentUser);
          App.showToast('Field updated successfully');
        }
      }
    }

    // Download health report
    function downloadHealthReport() {
      if (!currentUser) return;

      // Create a simple text report
      const report = `
AROGYA REKHA - HEALTH REPORT
============================

Personal Information:
- Name: ${currentUser.name || 'Not provided'}
- Health ID: ${currentUser.healthId || 'Not assigned'}
- Date of Birth: ${currentUser.dob ? formatDate(currentUser.dob) : 'Not provided'}
- Gender: ${currentUser.gender || 'Not provided'}
- Blood Group: ${currentUser.bloodGroup || 'Not provided'}
- Home State: ${currentUser.homeState || 'Not provided'}
- Phone: ${currentUser.phone || 'Not provided'}

Medical Information:
- Allergies: ${currentUser.allergies || 'None recorded'}
- Chronic Conditions: ${currentUser.chronicConditions || 'None recorded'}
- Current Medications: ${currentUser.medications || 'None recorded'}
- Last Health Check: ${currentUser.lastHealthCheck || 'Not recorded'}

Emergency Contact:
- Contact: ${currentUser.emergencyContact || 'Not set'}

Generated on: ${new Date().toLocaleDateString('en-IN')}
      `;

      // Create and download file
      const blob = new Blob([report], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `health-report-${currentUser.healthId || 'unknown'}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);

      App.showToast('Health report downloaded');
    }

    // Share profile
    function shareProfile() {
      if (!currentUser) return;

      const shareData = {
        title: 'My Health Profile - Arogya Rekha',
        text: `Health ID: ${currentUser.healthId || 'Not assigned'}`,
        url: window.location.href
      };

      if (navigator.share) {
        navigator.share(shareData).catch(console.error);
      } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(shareData.text).then(() => {
          App.showToast('Health ID copied to clipboard');
        });
      }
    }

    // View health history
    function viewHealthHistory() {
      App.showToast('Health history feature coming soon');
      // In a real app, this would navigate to a health history page
    }
  </script>
</body>
</html>
