<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Health ID Card - Arogya Rekha</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="health-id.css">
</head>
<body>
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-left">
        <a href="./login.html" class="back-btn">
          <i class="fas fa-arrow-left"></i>
        </a>
        <div class="header-title">
          <h1>Health ID Card</h1>
          <p>Your Digital Health Record</p>
        </div>
      </div>
      <div class="header-right">
        <button id="logoutBtn" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>
  </div>

  <div class="container py-3" style="max-width: 500px;">

    <!-- Health ID Card -->
    <div class="health-id-card">
      <!-- Header -->
      <div class="id-card-header">
        <h2>AROGYA REKHA - DIGITAL HEALTH RECORD</h2>
        <div class="website-logo"><i class="bi bi-heart-pulse"></i></div>
        <h3>MIGRANT WORKER HEALTH ID</h3>
      </div>

      <!-- Card Body -->
      <div class="card-body">
        <!-- Left Section -->
        <div class="left-section">
          <div class="worker-photo">
            <img id="workerPhoto" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzFCNEY3MiIgc3Ryb2tlLXdpZHRoPSIxIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0yMCAyMWMtMi4yIDAtMTEuOCAwLTE2IDBtMTYtMTBjMC00LjQtMy42LTgtOC04cy04IDMuNi04IDggMy42IDggOCA4IDgtMy42IDgtOHoiLz48Y2lyY2xlIGN4PSIxMiIgY3k9IjEwIiByPSI0Ii8+PC9zdmc+" alt="Worker Photo">
          </div>
          <div class="worker-name" id="workerName">—</div>
          <div class="basic-info">
            <div class="info-item">
              <span class="label">Gender:</span>
              <span class="value" id="workerGender">—</span>
            </div>
            <div class="info-item">
              <span class="label">DOB:</span>
              <span class="value" id="workerDOB">—</span>
            </div>
            <div class="info-item blood-group-section">
              <span class="label">Blood Group:</span>
              <span class="value blood-type" id="bloodGroup">—</span>
            </div>
            <div class="info-item">
              <span class="label">Home State:</span>
              <span class="value" id="homeState">—</span>
            </div>
          </div>
        </div>
        
        <!-- Center Section -->
        <div class="center-section">
          <h2 class="health-id-heading">Health ID</h2>
          <div class="health-id-number" id="healthIdText">MW------</div>
        </div>
        
        <!-- Right Section -->
        <div class="right-section">
          <div class="qr-code-container">
            <div id="qr-code"></div>
            <p class="qr-label">Scan for Details</p>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="card-footer">
        <div class="left-footer">
          <span class="digital-signature">Digitally Signed by Kerala Health Department</span>
        </div>
        <div class="right-footer">
          <div class="issue-date">Issue: <span id="issueDate">—</span></div>
          <div class="emergency-contact">Emergency: <span id="emergencyContact">—</span></div>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="action-btn save-btn" onclick="saveToPhone()">
        <i class="fas fa-download"></i> Save to Phone
      </button>
      <button class="action-btn share-btn" onclick="shareCard()">
        <i class="fas fa-share"></i> Share
      </button>
      <button class="action-btn print-btn" onclick="printCard()">
        <i class="fas fa-print"></i> Print
      </button>
    </div>

    <!-- Services Section -->
    <div class="services-section">
      <h4 class="services-title">Services</h4>
      <div class="services-grid">
        <div class="service-card" onclick="navigateToAppointments()">
          <div class="service-icon">
            <i class="fas fa-calendar-check"></i>
          </div>
          <div class="service-content">
            <h5>Appointments</h5>
            <p>Book and manage your health appointments</p>
          </div>
        </div>
        <div class="service-card" onclick="navigateToMyHealth()">
          <div class="service-icon">
            <i class="fas fa-heartbeat"></i>
          </div>
          <div class="service-content">
            <h5>My Health</h5>
            <p>View your health records and history</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation Footer -->
  <div class="bottom-nav">
    <div class="nav-item active">
      <i class="fas fa-home"></i>
      <span>Home</span>
    </div>
    <div class="nav-item" onclick="navigateToProfile()">
      <i class="fas fa-user"></i>
      <span>Profile</span>
    </div>
  </div>

  <div class="app-toast" role="status" aria-live="polite"></div>

  <script src="../../js/data.js"></script>
  <script src="../../js/main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
    // Get worker data
    // Get current user data
    const currentUser = UserManager.getCurrentUser();
    const selectedWorkerId = App.getSelectedWorker();
    const worker = currentUser || (selectedWorkerId ? App.findWorkerById(selectedWorkerId) : null);
    
    // Debug: Log the worker data
    console.log('Current user:', currentUser);
    console.log('Selected worker ID:', selectedWorkerId);
    console.log('Worker data:', worker);
    
    if (!worker) { window.location.href = './register.html'; }

    // Format date as DD/MM/YYYY
    function formatDate(dateString) {
      if (!dateString) return '—';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-IN');
    }

    // Populate card with worker data
    function populateCard() {
      // Basic Info
      document.getElementById('workerName').textContent = worker.name || '—';
      document.getElementById('workerGender').textContent = worker.gender || '—';
      document.getElementById('workerDOB').textContent = worker.dob ? formatDate(worker.dob) : '—';
      document.getElementById('bloodGroup').textContent = worker.bloodGroup || '—';
      document.getElementById('homeState').textContent = worker.homeState || '—';
      document.getElementById('healthIdText').textContent = worker.healthId || 'MW------';
      
      // Set issue date to today
      document.getElementById('issueDate').textContent = new Date().toLocaleDateString('en-IN');
      
      // Set emergency contact if available
      document.getElementById('emergencyContact').textContent = worker.emergencyContact || '—';
      
      // Set photo if available
      if (worker.photo) {
        document.getElementById('workerPhoto').src = worker.photo;
      }
      
      // Generate QR code
      generateQRCode(worker.healthId || 'AROGYA_REKHA_DEMO');
    }
    
    // Generate QR Code
    function generateQRCode(data) {
      try {
        // Clear previous QR code
        const container = document.getElementById('qr-code');
        container.innerHTML = '';
        
        // Create new QR code
        new QRCode(container, {
          text: data,
          width: 70,
          height: 70,
          colorDark: '#1B4F72',
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });
      } catch (e) {
        console.error('Error generating QR code:', e);
        // Fallback to image if QR code generation fails
        const container = document.getElementById('qr-code');
        const img = document.createElement('img');
        img.src = `https://api.qrserver.com/v1/create-qr-code/?size=70x70&data=${encodeURIComponent(data)}`;
        img.alt = 'Health ID QR Code';
        container.appendChild(img);
      }
    }
    
    // Save to Phone
    async function saveToPhone() {
      try {
        // In a real app, this would save the card as an image
        // For now, we'll just show a success message
        App.showToast('Card saved to your device');
      } catch (e) {
        console.error('Error saving card:', e);
        App.showToast('Error saving card', 'error');
      }
    }
    
    // Share Card
    async function shareCard() {
      try {
        if (navigator.share) {
          await navigator.share({
            title: 'My Health ID Card',
            text: `Health ID: ${worker.healthId || 'Not available'}`,
            // In a real app, you might want to share an image of the card
          });
        } else {
          // Fallback for browsers that don't support Web Share API
          await navigator.clipboard.writeText(worker.healthId || 'Health ID not available');
          App.showToast('Health ID copied to clipboard');
        }
      } catch (e) {
        console.error('Error sharing:', e);
        // Don't show error if user canceled the share
        if (e.name !== 'AbortError') {
          App.showToast('Error sharing card', 'error');
        }
      }
    }
    
    // Print Card
    function printCard() {
      window.print();
    }
    
    // Navigation functions
    function navigateToAppointments() {
      // For now, show a placeholder message
      App.showToast('Appointments feature coming soon!');
      // In the future, this would navigate to appointments page
      // window.location.href = './appointments.html';
    }
    
    function navigateToMyHealth() {
      // For now, show a placeholder message
      App.showToast('My Health feature coming soon!');
      // In the future, this would navigate to health records page
      // window.location.href = './my-health.html';
    }
    
    function navigateToProfile() {
      // Navigate to profile section or page
      App.showToast('Profile feature coming soon!');
      // In the future, this would navigate to profile page
      // window.location.href = './profile.html';
    }
    
    // Initialize the card when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      populateCard();
    });

    // Logout functionality
    document.addEventListener('DOMContentLoaded', () => {
      const logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.addEventListener('click', function() {
          console.log('Logout button clicked'); // Debug log
          if (confirm('Are you sure you want to logout?')) {
            try {
              // Clear current user from UserManager
              if (typeof UserManager !== 'undefined') {
                UserManager.clearCurrentUser();
                console.log('UserManager cleared'); // Debug log
              }
              
              // Also clear from App for backward compatibility
              if (typeof App !== 'undefined') {
                localStorage.removeItem(App.STORAGE_KEYS.selectedWorkerId);
                console.log('App storage cleared'); // Debug log
              }
              
              // Show logout message
              App.showToast('Logged out successfully');
              
              // Redirect to main page
              setTimeout(() => {
                window.location.href = '../../index.html';
              }, 1000);
            } catch (error) {
              console.error('Logout error:', error);
              // Fallback: just redirect
              window.location.href = '../../index.html';
            }
          }
        });
      } else {
        console.error('Logout button not found');
      }
    });
  </script>
</body>
</html>
