<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Record</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../../css/main.css" />
    <link rel="stylesheet" href="../../css/mobile.css" />
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <a href="./dashboard.html" class="text-decoration-none small">&larr; Back</a>
        <div class="d-flex gap-2">
          <button id="printBtn" class="btn btn-outline-secondary btn-sm">Print</button>
          <button id="testDataBtn" class="btn btn-info btn-sm">Test Data</button>
          <a href="../../index.html" class="btn btn-warning btn-sm">Logout</a>
        </div>
      </div>
      <div id="profileCard" class="card card-elevated p-3">
        <div class="d-flex flex-column flex-md-row justify-content-between gap-3">
          <div>
            <div class="small text-muted">Health ID</div>
            <div class="h5" id="pid">—</div>
            <div class="fw-bold" id="pname">—</div>
            <div class="text-muted" id="pmeta">—</div>
            <div class="mt-2">
              <span id="statusBadge" class="badge bg-secondary">—</span>
              <span class="small text-muted">Last visit: <span id="lastVisit">—</span></span>
              <span class="small text-muted ms-2" id="nextApptWrap" style="display:none;">Next: <span id="nextAppt">—</span></span>
            </div>
            <div class="mt-2 d-flex gap-2">
              <button id="btnSchedule" class="btn btn-outline-primary btn-sm">Schedule Appointment</button>
              <button id="btnMarkCritical" class="btn btn-outline-primary btn-sm">Mark Critical</button>
              <button id="btnEmergencyContact" class="btn btn-success btn-sm">Contact Emergency</button>
            </div>
          </div>
          <div class="qr-box align-self-center align-self-md-start"><div id="qr"></div></div>
        </div>
      </div>

      <ul class="nav nav-tabs mt-3" id="tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">History</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#vaccinations" type="button" role="tab">Vaccinations</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#prescriptions" type="button" role="tab">Prescriptions</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#allergies" type="button" role="tab">Allergies</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">Clinical Notes</button>
        </li>
      </ul>

      <div class="tab-content">
        <div id="overview" class="tab-pane fade show active p-3">
          <div class="small text-muted">Recent Records</div>
          <div id="recordsTimeline" class="mt-2"></div>
          <hr />
          <div class="d-grid d-md-flex gap-2">
            <button class="btn btn-success" type="button" data-bs-toggle="modal" data-bs-target="#recordModal">Add Record</button>
            <button class="btn btn-outline-primary" type="button" id="exportBtn">Export</button>
          </div>
        </div>
        <div id="history" class="tab-pane fade p-3">
          <div id="historyList"></div>
        </div>
        <div id="vaccinations" class="tab-pane fade p-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="small text-muted">Vaccination Records</div>
            <button id="addVaccinationBtn" class="btn vaccination-add-btn btn-sm" type="button" data-bs-toggle="modal" data-bs-target="#vaccinationModal">
              <i class="bi bi-plus-circle me-1"></i>Add Vaccination
            </button>
          </div>
          <div id="vaccinationsList" class="mt-2"></div>
        </div>
        <div id="prescriptions" class="tab-pane fade p-3">
          <div class="small text-muted">Current & Past Prescriptions</div>
          <div id="prescriptionsList" class="mt-2"></div>
        </div>
        <div id="allergies" class="tab-pane fade p-3">
          <div class="d-flex flex-column flex-md-row gap-3">
            <div class="flex-grow-1">
              <div class="small text-muted">Recorded Allergies</div>
              <div id="allergyList" class="mt-2"></div>
            </div>
            <div class="flex-grow-1">
              <div class="small text-muted">Add New Allergy</div>
              <form id="allergyForm" class="needs-validation mt-2" novalidate>
                <div class="row g-2">
                  <div class="col-12 col-md-6">
                    <label class="form-label">Allergy Name</label>
                    <input name="name" class="form-control" placeholder="e.g., Penicillin" required />
                    <div class="invalid-feedback">Required</div>
                  </div>
                  <div class="col-12 col-md-6">
                    <label class="form-label">Type</label>
                    <select name="type" class="form-select" required>
                      <option value="">Select type</option>
                      <option value="medication">Medication</option>
                      <option value="food">Food</option>
                      <option value="environmental">Environmental</option>
                    </select>
                    <div class="invalid-feedback">Select a type</div>
                  </div>
                </div>
                <div class="mt-2">
                  <label class="form-label">Description (optional)</label>
                  <textarea name="description" class="form-control" rows="3" placeholder="Reaction, severity, notes..."></textarea>
                </div>
                <div class="d-grid d-md-flex gap-2 mt-2">
                  <button type="submit" class="btn btn-success">Add Allergy</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div id="notes" class="tab-pane fade p-3">
          <div class="small text-muted">Private Clinical Notes</div>
          <textarea id="clinicalNotes" class="form-control mt-2" rows="5" placeholder="Enter private observations..."></textarea>
          <div class="d-grid d-md-flex gap-2 mt-2">
            <button id="saveNotes" class="btn btn-outline-primary btn-sm" type="button">Save Notes</button>
          </div>
        </div>
      </div>

      <div class="app-toast"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="../../js/data.js"></script>
    <script src="../../js/main.js"></script>
    <script src="../../js/provider.js"></script>
    <script src="../../js/qr-generator.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');

      // Initialize UserManager and force use of new data
      if (typeof UserManager !== 'undefined') {
        UserManager.initMockUsers();
        
        // ALWAYS use UserManager data (ignore old App data)
        const users = UserManager.getAllUsers();
        if (users && users.length > 0) {
          // Try to find specific user by ID, or use first user as default
          worker = users.find(u => u.healthId === id) || users[0];
        }
      }
      
      // If still no worker, create a basic one
      if (!worker) {
        worker = {
          healthId: id || 'MW123456',
          name: 'Rahul Kumar',
          age: 28,
          gender: 'Male',
          homeState: 'Bihar',
          currentLocation: { district: 'Ernakulam' },
          status: 'Active',
          nextAppointment: null,
          records: [
            {
              date: '2025-01-15',
              time: '10:30',
              visitType: 'Consultation',
              chiefComplaint: 'Fever and body ache',
              bp: '118/76',
              temp: '100.4°F',
              hr: '78 bpm',
              weight: '66 kg',
              diagnosis: 'Viral fever',
              treatment: 'Rest, hydration, antipyretics',
              prescription: 'Paracetamol 500mg, 3/day for 5 days'
            }
          ],
          history: [
            { date: '2023-07-22', type: 'Diagnosis', notes: 'Typhoid fever treated successfully.' },
            { date: '2024-06-12', type: 'Diagnosis', notes: 'Lower back pain; advised physiotherapy.' }
          ],
          vaccinations: [
            { 
              name: 'COVID-19 (Covishield)', 
              doses: 2, 
              lastDate: '2022-05-20',
              dateAdministered: '2022-05-20',
              doseNumber: 2,
              administeredBy: 'Dr. Sarah Johnson',
              notes: 'Second dose completed'
            }
          ],
          prescriptions: [
            { drug: 'Paracetamol', strength: '500mg', frequency: '3/day', duration: '5 days', reason: 'Fever', date: '2025-01-15' }
          ],
          allergies: [
            { name: 'Penicillin', type: 'medication', description: 'Reaction: rash. Note: avoid penicillin-class drugs.' }
          ],
          clinicalNotes: 'Patient is a migrant worker with good overall health. Regular follow-ups recommended.'
        };
      }

      // Ensure all required arrays exist
      worker.records = worker.records || [];
      worker.history = worker.history || [];
      worker.vaccinations = worker.vaccinations || [];
      worker.prescriptions = worker.prescriptions || [];
      worker.allergies = worker.allergies || [];
      worker.clinicalNotes = worker.clinicalNotes || 'No clinical notes available.';

      // First populate basic patient information
      document.getElementById('pid').textContent = worker.healthId;
      document.getElementById('pname').textContent = worker.name;
      document.getElementById('pmeta').textContent = `${worker.gender}, ${worker.age} • ${worker.homeState} • ${(worker.currentLocation?.district)||'Kerala'}`;
      QR.render('qr', worker.healthId, 120);

      // Now render all sections with the loaded data (with a small delay to ensure DOM is ready)
      setTimeout(() => {
        console.log('About to render sections, worker data:', worker);
        console.log('Worker history:', worker.history);
        console.log('Worker vaccinations:', worker.vaccinations);
        console.log('Worker prescriptions:', worker.prescriptions);
        console.log('Worker allergies:', worker.allergies);
        
        renderTimeline();
        renderHistory();
        renderVaccinations();
        renderPrescriptions();
        renderAllergies();
        
        // Force show History tab for testing
        console.log('Forcing History tab to be visible...');
        const historyTab = document.querySelector('[data-bs-target="#history"]');
        const historyPane = document.getElementById('history');
        if (historyTab && historyPane) {
          // Remove active from overview
          document.querySelector('[data-bs-target="#overview"]').classList.remove('active');
          document.getElementById('overview').classList.remove('show', 'active');
          
          // Add active to history
          historyTab.classList.add('active');
          historyPane.classList.add('show', 'active');
          console.log('History tab is now active');
        }
      }, 100);

      // Pre-fill clinical notes textarea
      const ta = document.getElementById('clinicalNotes');
      if (ta && worker.clinicalNotes) ta.value = worker.clinicalNotes;

      // status badge + last visit
      (function(){
        const last = (worker.records||[]).slice().sort((a,b)=>(b.date||'').localeCompare(a.date||''))[0];
        document.getElementById('lastVisit').textContent = last ? last.date : '—';
        const status = worker.status || 'Active';
        const badge = document.getElementById('statusBadge');
        badge.textContent = status;
        badge.className = 'badge ' + (status==='Critical' ? 'bg-danger' : status==='Active' ? 'bg-success' : status==='Stable' ? 'bg-success' : 'bg-secondary');
        if (worker.nextAppointment) {
          document.getElementById('nextAppt').textContent = `${worker.nextAppointment.date} ${worker.nextAppointment.time||''}`;
          document.getElementById('nextApptWrap').style.display = '';
        }
      })();

      function renderTimeline() {
        Provider.displayTimelineRecords('recordsTimeline', worker.records||[]);
      }

      function renderHistory() {
        const container = document.getElementById('historyList');
        console.log('renderHistory called, container:', container);
        if (!container) {
          console.error('historyList container not found!');
          return;
        }
        
        // First, add a test message to verify the container is working
        container.innerHTML = '<div class="alert alert-info">Testing History Rendering...</div>';
        
        const hist = worker.history || [];
        console.log('History data:', hist);
        
        // Clear the test message and render actual content
        container.innerHTML = '';
        
        if (hist.length === 0) { 
          // Fallback: render some basic history data for testing
          container.innerHTML = `
            <div class="border rounded p-3 mb-3 bg-light">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <div class="small text-muted mb-1">2023-07-22</div>
                  <div class="fw-semibold text-primary mb-1">Diagnosis</div>
                  <div class="text-muted small">Typhoid fever treated successfully with antibiotics.</div>
                </div>
                <span class="badge bg-secondary ms-2">Diagnosis</span>
              </div>
            </div>
            <div class="border rounded p-3 mb-3 bg-light">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <div class="small text-muted mb-1">2024-06-12</div>
                  <div class="fw-semibold text-primary mb-1">Diagnosis</div>
                  <div class="text-muted small">Lower back pain due to heavy lifting; advised physiotherapy and NSAIDs.</div>
                </div>
                <span class="badge bg-secondary ms-2">Diagnosis</span>
              </div>
            </div>
            <div class="text-muted small">Fallback history data - UserManager data not loaded</div>
          `;
          return; 
        }
        
        // Sort by date (most recent first) and render
        hist.slice().sort((a, b) => {
          if (a.date === '—') return 1;
          if (b.date === '—') return -1;
          return new Date(b.date) - new Date(a.date);
        }).forEach(h => {
          const el = document.createElement('div');
          el.className = 'border rounded p-3 mb-3 bg-light';
          el.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="small text-muted mb-1">${h.date}</div>
                <div class="fw-semibold text-primary mb-1">${h.type}</div>
                <div class="text-muted small">${h.notes}</div>
              </div>
              <span class="badge bg-secondary ms-2">${h.type}</span>
            </div>
          `;
          container.appendChild(el);
        });
      }

      // Functions will be called after worker data is loaded

      // Vaccinations: render list for demo and real data
      function renderVaccinations() {
        const container = document.getElementById('vaccinationsList');
        console.log('renderVaccinations called, container:', container);
        if (!container) {
          console.error('vaccinationsList container not found!');
          return;
        }
        container.innerHTML = '';
        const list = worker.vaccinations || [];
        console.log('Vaccinations data:', list);
        if (list.length === 0) { 
          container.innerHTML = '<div class="text-muted">No vaccination records</div>'; 
          return; 
        }
        // Sort vaccinations by date (most recent first)
        const sortedList = list.slice().sort((a, b) => {
          const dateA = new Date(a.dateAdministered || a.lastDate || '1900-01-01');
          const dateB = new Date(b.dateAdministered || b.lastDate || '1900-01-01');
          return dateB - dateA;
        });

        const group = document.createElement('div');
        group.className = 'list-group';
        sortedList.forEach((v, index) => {
          const originalIndex = list.indexOf(v);
          const isMostRecent = index === 0;
          const row = document.createElement('div');
          row.className = `list-group-item vaccination-record d-flex justify-content-between align-items-start flex-column flex-md-row gap-2 ${isMostRecent ? 'border-primary' : ''}`;
          row.innerHTML = `
            <div class="flex-grow-1">
              <div class="fw-semibold text-primary-brand">
                ${v.name}
                ${isMostRecent ? '<span class="badge bg-primary ms-2" style="font-size: 0.6rem;">Most Recent</span>' : ''}
              </div>
              <div class="text-muted small">
                <span class="vaccination-badge bg-light text-dark">Dose ${v.doseNumber || v.doses || '-'}</span>
                <span class="vaccination-date ms-2">${v.dateAdministered || v.lastDate || '-'}</span>
                <span class="vaccination-provider ms-2">By: ${v.administeredBy || '-'}</span>
              </div>
              ${v.notes ? `<div class="vaccination-notes small mt-2">${v.notes}</div>` : ''}
            </div>
            <div class="d-flex gap-1 align-items-center">
              <span class="badge bg-success vaccination-badge">Completed</span>
              <button type="button" class="btn btn-outline-danger btn-sm" data-action="remove-vaccination" data-index="${originalIndex}" title="Remove vaccination">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          `;
          group.appendChild(row);
        });
        container.appendChild(group);
      }

      // Prescriptions: render list items
      function renderPrescriptions() {
        const container = document.getElementById('prescriptionsList');
        console.log('renderPrescriptions called, container:', container);
        if (!container) {
          console.error('prescriptionsList container not found!');
          return;
        }
        container.innerHTML = '';
        const list = worker.prescriptions || [];
        console.log('Prescriptions data:', list);
        if (list.length === 0) { 
          container.innerHTML = '<div class="text-muted">No prescriptions</div>'; 
          return; 
        }
        const group = document.createElement('div');
        group.className = 'list-group';
        list.forEach(p => {
          const row = document.createElement('div');
          row.className = 'list-group-item';
          row.innerHTML = `
            <div class="d-flex justify-content-between flex-column flex-md-row gap-1">
              <div class="fw-semibold">${p.drug} ${p.strength}</div>
              <div class="text-muted small">${p.date||''}</div>
            </div>
            <div class="small">${p.frequency} for ${p.duration}</div>
            <div class="text-muted small">Reason: ${p.reason||'-'}</div>
          `;
          group.appendChild(row);
        });
        container.appendChild(group);
      }

      // Clinical notes seeding moved to after worker data is loaded

      // Render calls are now handled above after worker data is loaded

      // Ensure allergies exist and re-render (already done below as well)
      worker.allergies = Array.isArray(worker.allergies) ? worker.allergies : [];

      // ------------------ Allergies Section ------------------
      // Ensure allergies array exists for the current worker in local state
      worker.allergies = Array.isArray(worker.allergies) ? worker.allergies : [];

      // Map type to a human friendly label and bootstrap color
      const allergyTypeMeta = {
        medication: { label: 'Medication', color: 'danger' },
        food: { label: 'Food', color: 'warning' },
        environmental: { label: 'Environmental', color: 'info' }
      };

      // Render the list of allergies
      function renderAllergies() {
        const container = document.getElementById('allergyList');
        console.log('renderAllergies called, container:', container);
        if (!container) {
          console.error('allergyList container not found!');
          return;
        }
        container.innerHTML = '';
        const list = worker.allergies || [];
        console.log('Allergies data:', list);
        if (list.length === 0) {
          container.innerHTML = '<div class="text-muted">No recorded allergies</div>';
          return;
        }
        const ul = document.createElement('div');
        ul.className = 'list-group';
        list.forEach((item, index) => {
          const meta = allergyTypeMeta[item.type] || { label: item.type || 'Other', color: 'secondary' };
          const row = document.createElement('div');
          row.className = 'list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2';
          row.innerHTML = `
            <div>
              <div class="fw-semibold">${item.name || '—'}
                <span class="badge bg-${meta.color} ms-1">${meta.label}</span>
              </div>
              ${item.description ? `<div class="text-muted small">${item.description}</div>` : ''}
            </div>
            <div class="ms-md-3">
              <button type="button" class="btn btn-outline-danger btn-sm" data-action="remove-allergy" data-index="${index}">Remove</button>
            </div>
          `;
          ul.appendChild(row);
        });
        container.appendChild(ul);
      }

      renderAllergies();

      // Handle add allergy form submit
      document.getElementById('allergyForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const form = e.target;
        // Validate required fields similar to other forms
        if (!form.checkValidity()) { form.classList.add('was-validated'); App.showToast('Please complete required fields', 'error'); return; }
        const fd = new FormData(form);
        const name = (fd.get('name')||'').toString().trim();
        const type = (fd.get('type')||'').toString();
        const description = (fd.get('description')||'').toString().trim();
        // Append to local state for current worker
        worker.allergies.push({ name, type, description });
        // Persist to local storage using existing helper
        App.saveWorker(worker);
        // Re-render list immediately
        renderAllergies();
        App.showToast('Allergy added');
        form.reset();
        form.classList.remove('was-validated');
      });

      // Delegate remove action for allergies list
      document.getElementById('allergyList')?.addEventListener('click', (e) => {
        const target = e.target;
        if (!(target instanceof HTMLElement)) return;
        if (target.dataset.action === 'remove-allergy') {
          const idxStr = target.dataset.index || '-1';
          const idx = parseInt(idxStr, 10);
          if (!Number.isNaN(idx) && idx >= 0 && idx < (worker.allergies?.length||0)) {
            // Remove from array and persist
            worker.allergies.splice(idx, 1);
            App.saveWorker(worker);
            renderAllergies();
            App.showToast('Allergy removed');
          }
        }
      });

      // Add Record modal handling
      document.getElementById('addRecordForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) { form.classList.add('was-validated'); App.showToast('Please complete required fields', 'error'); return; }
        const fd = new FormData(form);
        const data = Object.fromEntries(fd.entries());
        Provider.saveEnhancedRecord(worker, data);
        renderTimeline();
        App.showToast('Record added');
        const modal = document.getElementById('recordModal');
        const closeBtn = modal.querySelector('[data-bs-dismiss="modal"]');
        if (closeBtn) closeBtn.click();
        form.reset();
      });

      document.getElementById('exportBtn').addEventListener('click', () => {
        Provider.generateMedicalReport(worker);
      });

      document.getElementById('printBtn').addEventListener('click', () => window.print());

      document.getElementById('testDataBtn').addEventListener('click', () => {
        const summary = `
Patient: ${worker.name} (${worker.healthId})
Age: ${worker.age}, Gender: ${worker.gender}
Home State: ${worker.homeState}
Location: ${worker.currentLocation?.district || 'Kerala'}
Status: ${worker.status}

Records: ${worker.records.length}
History: ${worker.history.length}
Vaccinations: ${worker.vaccinations.length}
Prescriptions: ${worker.prescriptions.length}
Allergies: ${worker.allergies.length}

DOM Elements Check:
- historyList: ${document.getElementById('historyList') ? 'Found' : 'Missing'}
- vaccinationsList: ${document.getElementById('vaccinationsList') ? 'Found' : 'Missing'}
- prescriptionsList: ${document.getElementById('prescriptionsList') ? 'Found' : 'Missing'}
- allergyList: ${document.getElementById('allergyList') ? 'Found' : 'Missing'}

History Items:
${worker.history.map(h => `- ${h.date}: ${h.type} - ${h.notes}`).join('\n')}
        `;
        alert(summary);
        console.log('Full worker data:', worker);
        console.log('DOM elements check:', {
          historyList: document.getElementById('historyList'),
          vaccinationsList: document.getElementById('vaccinationsList'),
          prescriptionsList: document.getElementById('prescriptionsList'),
          allergyList: document.getElementById('allergyList')
        });
      });

      // quick actions
      document.getElementById('btnSchedule').addEventListener('click', () => {
        const modal = document.getElementById('apptModal');
        if (window.bootstrap) new bootstrap.Modal(modal).show();
      });
      document.getElementById('btnMarkCritical').addEventListener('click', () => {
        worker.status = 'Critical';
        App.saveWorker(worker);
        App.showToast('Marked as Critical');
        document.getElementById('statusBadge').className = 'badge bg-danger';
        document.getElementById('statusBadge').textContent = 'Critical';
      });
      document.getElementById('btnEmergencyContact').addEventListener('click', () => {
        App.showToast('Contacting emergency services…');
      });

      document.getElementById('saveNotes').addEventListener('click', () => {
        const notes = document.getElementById('clinicalNotes').value || '';
        worker.clinicalNotes = notes;
        App.saveWorker(worker);
        App.showToast('Notes saved');
      });

      // Ensure vaccinations array exists for the current worker
      worker.vaccinations = Array.isArray(worker.vaccinations) ? worker.vaccinations : [];

      // Set max date for vaccination date input to today
      document.addEventListener('DOMContentLoaded', function() {
        const dateInput = document.querySelector('input[name="dateAdministered"]');
        if (dateInput) {
          const today = new Date().toISOString().split('T')[0];
          dateInput.setAttribute('max', today);
        }
      });

      // Handle vaccination form submission
      document.getElementById('vaccinationForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const form = e.target;
        
        // Validate form
        if (!form.checkValidity()) { 
          form.classList.add('was-validated'); 
          App.showToast('Please complete required fields', 'error'); 
          return; 
        }

        const fd = new FormData(form);
        const vaccineName = (fd.get('vaccineName') || '').toString().trim();
        const dateAdministered = (fd.get('dateAdministered') || '').toString();
        const doseNumber = parseInt((fd.get('doseNumber') || '0').toString(), 10);
        const administeredBy = (fd.get('administeredBy') || '').toString().trim();
        const notes = (fd.get('notes') || '').toString().trim();

        // Validate date is not in the future
        const selectedDate = new Date(dateAdministered);
        const today = new Date();
        today.setHours(23, 59, 59, 999); // End of today
        if (selectedDate > today) {
          App.showToast('Vaccination date cannot be in the future', 'error');
          return;
        }

        // Create vaccination record
        const vaccinationRecord = {
          name: vaccineName,
          dateAdministered: dateAdministered,
          doseNumber: doseNumber,
          administeredBy: administeredBy,
          notes: notes,
          // Keep backward compatibility
          doses: doseNumber,
          lastDate: dateAdministered
        };

        // Add to worker's vaccination records
        worker.vaccinations.push(vaccinationRecord);
        
        // Save to localStorage
        App.saveWorker(worker);
        
        // Re-render vaccination list
        renderVaccinations();
        
        // Show success message
        App.showToast('Vaccination record added successfully');
        
        // Close modal and reset form
        const modal = document.getElementById('vaccinationModal');
        const closeBtn = modal.querySelector('[data-bs-dismiss="modal"]');
        if (closeBtn) closeBtn.click();
        form.reset();
        form.classList.remove('was-validated');
      });

      // Handle remove vaccination action
      document.getElementById('vaccinationsList')?.addEventListener('click', (e) => {
        const target = e.target.closest('[data-action="remove-vaccination"]');
        if (!target) return;
        
        const idxStr = target.dataset.index || '-1';
        const idx = parseInt(idxStr, 10);
        
        if (!Number.isNaN(idx) && idx >= 0 && idx < (worker.vaccinations?.length || 0)) {
          const vaccination = worker.vaccinations[idx];
          
          // Confirm deletion
          if (confirm(`Are you sure you want to remove the ${vaccination.name} vaccination record?`)) {
            worker.vaccinations.splice(idx, 1);
            App.saveWorker(worker);
            renderVaccinations();
            App.showToast('Vaccination record removed');
          }
        }
      });
    </script>

    <!-- Add Record Modal -->
    <div class="modal fade" id="recordModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Medical Record</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="addRecordForm" class="needs-validation" novalidate>
            <div class="modal-body">
              <div class="row g-2">
                <div class="col-12 col-md-4">
                  <label class="form-label">Visit Type</label>
                  <select name="visitType" class="form-select" required>
                    <option>Consultation</option>
                    <option>Emergency</option>
                    <option>Follow-up</option>
                    <option>Procedure</option>
                  </select>
                </div>
                <div class="col-6 col-md-4">
                  <label class="form-label">Date</label>
                  <input name="date" type="date" class="form-control" required />
                </div>
                <div class="col-6 col-md-4">
                  <label class="form-label">Time</label>
                  <input name="time" type="time" class="form-control" />
                </div>
              </div>
              <div class="mt-2">
                <label class="form-label">Chief Complaint</label>
                <input name="chiefComplaint" class="form-control" required />
                <div class="invalid-feedback">Required</div>
              </div>
              <div class="vital-signs-grid mt-2">
                <div>
                  <label class="form-label">Blood Pressure</label>
                  <input name="bp" class="form-control" placeholder="120/80" />
                </div>
                <div>
                  <label class="form-label">Temperature</label>
                  <input name="temp" class="form-control" placeholder="98.6°F" />
                </div>
                <div>
                  <label class="form-label">Heart Rate</label>
                  <input name="hr" class="form-control" placeholder="72 bpm" />
                </div>
                <div>
                  <label class="form-label">Weight</label>
                  <input name="weight" class="form-control" placeholder="kg" />
                </div>
              </div>
              <div class="row g-2 mt-2">
                <div class="col-12 col-md-6">
                  <label class="form-label">Diagnosis</label>
                  <input name="diagnosis" class="form-control" required />
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Treatment</label>
                  <input name="treatment" class="form-control" required />
                </div>
              </div>
              <div class="mt-2">
                <label class="form-label">Prescription</label>
                <textarea name="prescription" class="form-control" rows="3"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Save Record</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Schedule Appointment Modal -->
    <div class="modal fade" id="apptModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Schedule Appointment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="apptForm" class="needs-validation" novalidate>
            <div class="modal-body">
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label">Date</label>
                  <input name="date" type="date" class="form-control" required />
                </div>
                <div class="col-6">
                  <label class="form-label">Time</label>
                  <input name="time" type="time" class="form-control" />
                </div>
              </div>
              <div class="mt-2">
                <label class="form-label">Notes</label>
                <input name="notes" class="form-control" />
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      document.getElementById('apptForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) { form.classList.add('was-validated'); App.showToast('Select a date', 'error'); return; }
        const fd = new FormData(form);
        Provider.scheduleAppointment(worker, { date: fd.get('date'), time: fd.get('time'), notes: fd.get('notes') });
        App.showToast('Appointment scheduled');
        document.getElementById('nextAppt').textContent = `${fd.get('date')} ${fd.get('time')||''}`;
        document.getElementById('nextApptWrap').style.display = '';
        const modal = document.getElementById('apptModal');
        const closeBtn = modal.querySelector('[data-bs-dismiss="modal"]');
        if (closeBtn) closeBtn.click();
        form.reset();
      });
    </script>

    <!-- Vaccination Modal -->
    <div class="modal fade vaccination-modal" id="vaccinationModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header vaccination-header">
            <h5 class="modal-title">Add Vaccination Record</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="vaccinationForm" class="needs-validation" novalidate>
            <div class="modal-body">
              <div class="row g-3">
                <div class="col-12 col-md-6">
                  <label class="form-label">Vaccine Name <span class="text-danger">*</span></label>
                  <select name="vaccineName" class="form-select" required>
                    <option value="">Select vaccine</option>
                    <option value="COVID-19 (Covishield)">COVID-19 (Covishield)</option>
                    <option value="COVID-19 (Covaxin)">COVID-19 (Covaxin)</option>
                    <option value="COVID-19 (Sputnik V)">COVID-19 (Sputnik V)</option>
                    <option value="Tetanus">Tetanus</option>
                    <option value="Tetanus (TT)">Tetanus (TT)</option>
                    <option value="Hepatitis B">Hepatitis B</option>
                    <option value="Polio (OPV)">Polio (OPV)</option>
                    <option value="Polio (IPV)">Polio (IPV)</option>
                    <option value="BCG">BCG</option>
                    <option value="Influenza">Influenza</option>
                    <option value="MMR">MMR (Measles, Mumps, Rubella)</option>
                    <option value="Typhoid">Typhoid</option>
                    <option value="Cholera">Cholera</option>
                    <option value="Rabies">Rabies</option>
                    <option value="Other">Other (specify in notes)</option>
                  </select>
                  <div class="invalid-feedback">Please select a vaccine</div>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Date Administered <span class="text-danger">*</span></label>
                  <input name="dateAdministered" type="date" class="form-control" required />
                  <div class="invalid-feedback">Please select a date</div>
                </div>
                <div class="col-12 col-md-4">
                  <label class="form-label">Dose Number <span class="text-danger">*</span></label>
                  <input name="doseNumber" type="number" class="form-control" min="1" max="10" placeholder="e.g., 1, 2, booster" required />
                  <div class="invalid-feedback">Please enter dose number</div>
                </div>
                <div class="col-12 col-md-8">
                  <label class="form-label">Administered By <span class="text-danger">*</span></label>
                  <input name="administeredBy" type="text" class="form-control" placeholder="Healthcare provider name" required />
                  <div class="invalid-feedback">Please enter provider name</div>
                </div>
                <div class="col-12">
                  <label class="form-label">Notes (optional)</label>
                  <textarea name="notes" class="form-control" rows="3" placeholder="Additional details, batch number, side effects, etc."></textarea>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Save Vaccination</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </body>
  </html>

