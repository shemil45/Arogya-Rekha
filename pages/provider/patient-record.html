<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Record</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../../css/main.css" />
    <link rel="stylesheet" href="../../css/mobile.css" />
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <a href="./dashboard.html" class="text-decoration-none small">&larr; Back</a>
        <div class="d-flex gap-2">
          <button id="printBtn" class="btn btn-outline-secondary btn-sm">Print</button>
          <a href="../../index.html" class="btn btn-warning btn-sm">Logout</a>
        </div>
      </div>
      <div id="profileCard" class="card card-elevated p-3">
        <div class="d-flex flex-column flex-md-row justify-content-between gap-3">
          <div>
            <div class="small text-muted">Health ID</div>
            <div class="h5" id="pid">—</div>
            <div class="fw-bold" id="pname">—</div>
            <div class="text-muted" id="pmeta">—</div>
          </div>
          <div class="qr-box align-self-center align-self-md-start"><div id="qr"></div></div>
        </div>
      </div>

      <ul class="nav nav-tabs mt-3" id="tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">History</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#vaccinations" type="button" role="tab">Vaccinations</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#prescriptions" type="button" role="tab">Prescriptions</button>
        </li>
      </ul>

      <div class="tab-content">
        <div id="overview" class="tab-pane fade show active p-3">
          <div class="small text-muted">Recent Records</div>
          <div id="recordsList" class="mt-2"></div>
          <hr />
          <h2 class="h6">Add New Record</h2>
          <form id="recordForm" class="row g-2">
            <div class="col-12 col-md-3">
              <input class="form-control" name="date" type="date" required />
            </div>
            <div class="col-12 col-md-9">
              <input class="form-control" name="symptoms" placeholder="Symptoms" required />
            </div>
            <div class="col-12 col-md-6">
              <input class="form-control" name="diagnosis" placeholder="Diagnosis" required />
            </div>
            <div class="col-12 col-md-6">
              <input class="form-control" name="treatment" placeholder="Treatment" required />
            </div>
            <div class="col-12 d-grid d-md-flex gap-2">
              <button class="btn btn-success" type="submit">Add Record</button>
              <button class="btn btn-outline-primary" type="button" id="exportBtn">Export</button>
            </div>
          </form>
        </div>
        <div id="history" class="tab-pane fade p-3">
          <div id="historyList"></div>
        </div>
        <div id="vaccinations" class="tab-pane fade p-3">
          <p class="text-muted">No vaccination records available in demo.</p>
        </div>
        <div id="prescriptions" class="tab-pane fade p-3">
          <p class="text-muted">No prescriptions available in demo.</p>
        </div>
      </div>

      <div class="app-toast"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/main.js"></script>
    <script src="../../js/qr-generator.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      const worker = App.findWorkerById(id);
      if (!worker) { window.location.href = './dashboard.html'; }

      document.getElementById('pid').textContent = worker.healthId;
      document.getElementById('pname').textContent = worker.name;
      document.getElementById('pmeta').textContent = `${worker.gender}, ${worker.age} • ${worker.homeState} • ${(worker.currentLocation?.district)||'Kerala'}`;
      QR.render('qr', worker.healthId, 120);

      function renderRecords() {
        const container = document.getElementById('recordsList');
        container.innerHTML = '';
        const records = worker.records || [];
        if (records.length === 0) { container.innerHTML = '<div class="text-muted">No records yet</div>'; return; }
        records.slice().reverse().forEach(r => {
          const el = document.createElement('div');
          el.className = 'card border-0 shadow-sm p-2 mb-2';
          el.innerHTML = `<div class="small text-muted">${r.date}</div><div class="fw-semibold">${r.diagnosis}</div><div class="text-muted small">${r.symptoms}</div><div class="small">Tx: ${r.treatment}</div>`;
          container.appendChild(el);
        });
      }

      function renderHistory() {
        const container = document.getElementById('historyList');
        container.innerHTML = '';
        const hist = worker.history || [];
        if (hist.length === 0) { container.innerHTML = '<div class="text-muted">No history</div>'; return; }
        hist.slice().reverse().forEach(h => {
          const el = document.createElement('div');
          el.className = 'border rounded p-2 mb-2';
          el.innerHTML = `<div class="small text-muted">${h.date}</div><div>${h.type}</div><div class="text-muted small">${h.notes}</div>`;
          container.appendChild(el);
        });
      }

      renderRecords();
      renderHistory();

      document.getElementById('recordForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const fd = new FormData(e.target);
        const newRecord = {
          date: fd.get('date') || new Date().toISOString().slice(0,10),
          symptoms: fd.get('symptoms'),
          diagnosis: fd.get('diagnosis'),
          treatment: fd.get('treatment')
        };
        worker.records = worker.records || [];
        worker.records.push(newRecord);
        App.saveWorker(worker);
        renderRecords();
        App.showToast('Record added');
        e.target.reset();
      });

      document.getElementById('exportBtn').addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(worker, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `${worker.healthId}.json`; a.click();
        URL.revokeObjectURL(url);
      });

      document.getElementById('printBtn').addEventListener('click', () => window.print());
    </script>
  </body>
  </html>

