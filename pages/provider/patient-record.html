<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Record</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../../css/main.css" />
    <link rel="stylesheet" href="../../css/mobile.css" />
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <a href="./dashboard.html" class="text-decoration-none small">&larr; Back</a>
        <div class="d-flex gap-2">
          <button id="printBtn" class="btn btn-outline-secondary btn-sm">Print</button>
          <a href="../../index.html" class="btn btn-warning btn-sm">Logout</a>
        </div>
      </div>
      <div id="profileCard" class="card card-elevated p-3">
        <div class="d-flex flex-column flex-md-row justify-content-between gap-3">
          <div>
            <div class="small text-muted">Health ID</div>
            <div class="h5" id="pid">—</div>
            <div class="fw-bold" id="pname">—</div>
            <div class="text-muted" id="pmeta">—</div>
            <div class="mt-2">
              <span id="statusBadge" class="badge bg-secondary">—</span>
              <span class="small text-muted">Last visit: <span id="lastVisit">—</span></span>
              <span class="small text-muted ms-2" id="nextApptWrap" style="display:none;">Next: <span id="nextAppt">—</span></span>
            </div>
            <div class="mt-2 d-flex gap-2">
              <button id="btnSchedule" class="btn btn-outline-primary btn-sm">Schedule Appointment</button>
              <button id="btnMarkCritical" class="btn btn-outline-primary btn-sm">Mark Critical</button>
              <button id="btnEmergencyContact" class="btn btn-success btn-sm">Contact Emergency</button>
            </div>
          </div>
          <div class="qr-box align-self-center align-self-md-start"><div id="qr"></div></div>
        </div>
      </div>

      <ul class="nav nav-tabs mt-3" id="tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">History</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#vaccinations" type="button" role="tab">Vaccinations</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#prescriptions" type="button" role="tab">Prescriptions</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#allergies" type="button" role="tab">Allergies</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">Clinical Notes</button>
        </li>
      </ul>

      <div class="tab-content">
        <div id="overview" class="tab-pane fade show active p-3">
          <div class="small text-muted">Recent Records</div>
          <div id="recordsTimeline" class="mt-2"></div>
          <hr />
          <div class="d-grid d-md-flex gap-2">
            <button class="btn btn-success" type="button" data-bs-toggle="modal" data-bs-target="#recordModal">Add Record</button>
            <button class="btn btn-outline-primary" type="button" id="exportBtn">Export</button>
          </div>
        </div>
        <div id="history" class="tab-pane fade p-3">
          <div id="historyList"></div>
        </div>
        <div id="vaccinations" class="tab-pane fade p-3">
          <div class="small text-muted">Vaccination Records</div>
          <div id="vaccinationsList" class="mt-2"></div>
        </div>
        <div id="prescriptions" class="tab-pane fade p-3">
          <div class="small text-muted">Current & Past Prescriptions</div>
          <div id="prescriptionsList" class="mt-2"></div>
        </div>
        <div id="allergies" class="tab-pane fade p-3">
          <div class="d-flex flex-column flex-md-row gap-3">
            <div class="flex-grow-1">
              <div class="small text-muted">Recorded Allergies</div>
              <div id="allergyList" class="mt-2"></div>
            </div>
            <div class="flex-grow-1">
              <div class="small text-muted">Add New Allergy</div>
              <form id="allergyForm" class="needs-validation mt-2" novalidate>
                <div class="row g-2">
                  <div class="col-12 col-md-6">
                    <label class="form-label">Allergy Name</label>
                    <input name="name" class="form-control" placeholder="e.g., Penicillin" required />
                    <div class="invalid-feedback">Required</div>
                  </div>
                  <div class="col-12 col-md-6">
                    <label class="form-label">Type</label>
                    <select name="type" class="form-select" required>
                      <option value="">Select type</option>
                      <option value="medication">Medication</option>
                      <option value="food">Food</option>
                      <option value="environmental">Environmental</option>
                    </select>
                    <div class="invalid-feedback">Select a type</div>
                  </div>
                </div>
                <div class="mt-2">
                  <label class="form-label">Description (optional)</label>
                  <textarea name="description" class="form-control" rows="3" placeholder="Reaction, severity, notes..."></textarea>
                </div>
                <div class="d-grid d-md-flex gap-2 mt-2">
                  <button type="submit" class="btn btn-success">Add Allergy</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div id="notes" class="tab-pane fade p-3">
          <div class="small text-muted">Private Clinical Notes</div>
          <textarea id="clinicalNotes" class="form-control mt-2" rows="5" placeholder="Enter private observations..."></textarea>
          <div class="d-grid d-md-flex gap-2 mt-2">
            <button id="saveNotes" class="btn btn-outline-primary btn-sm" type="button">Save Notes</button>
          </div>
        </div>
      </div>

      <div class="app-toast"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/main.js"></script>
    <script src="../../js/provider.js"></script>
    <script src="../../js/qr-generator.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');

      // Demo/mock worker for UI showcase when no worker is found via query
      const MOCK_WORKER = {
        healthId: 'RK-ERK-2801',
        name: 'Rahul Kumar',
        age: 28,
        gender: 'Male',
        homeState: 'Bihar',
        currentLocation: { district: 'Ernakulam' },
        status: 'Active',
        nextAppointment: null,
        records: [
          {
            date: '2025-08-15',
            time: '10:30',
            visitType: 'Consultation',
            chiefComplaint: 'Fever and body ache',
            bp: '118/76',
            temp: '100.4°F',
            hr: '78 bpm',
            weight: '66 kg',
            diagnosis: 'Viral fever',
            treatment: 'Rest, hydration, antipyretics',
            prescription: 'Paracetamol 500mg, 3/day for 5 days'
          }
        ],
        history: [
          { date: '2023-07-22', type: 'Diagnosis', notes: 'Typhoid fever treated successfully.' },
          { date: '2024-06-12', type: 'Diagnosis', notes: 'Lower back pain; advised physiotherapy and NSAIDs.' },
          { date: '2021-09-05', type: 'Diagnosis', notes: 'Malaria (P. vivax); completed antimalarial course.' },
          { date: '—', type: 'Surgeries', notes: 'None' },
          { date: '—', type: 'Chronic conditions', notes: 'None' }
        ],
        vaccinations: [
          { name: 'COVID-19 (Covishield)', doses: 2, lastDate: '2022-05-20' },
          { name: 'Tetanus', doses: 1, lastDate: '2023-03-10' },
          { name: 'Hepatitis B', doses: 1, lastDate: '2021-01-18' }
        ],
        prescriptions: [
          { drug: 'Paracetamol', strength: '500mg', frequency: '3/day', duration: '5 days', reason: 'Fever', date: '2025-08-15' },
          { drug: 'Ibuprofen', strength: '400mg', frequency: '2/day', duration: '7 days', reason: 'Back pain', date: '2024-06-12' }
        ],
        allergies: [
          { name: 'Penicillin', type: 'medication', description: 'Reaction: rash. Note: avoid all penicillin-class drugs.' },
          { name: 'Peanuts', type: 'food', description: 'Reaction: swelling. Note: carries epipen.' },
          { name: 'Dust', type: 'environmental', description: 'Reaction: sneezing. Note: mild severity.' }
        ],
        clinicalNotes: [
          'Patient is a migrant worker reporting increased fatigue due to long work hours. Advised rest, hydration, and periodic wellness check-ups.',
          'No psychological distress noted. BP and HR normal. Follow-up in one month.'
        ].join('\n\n')
      };

      let worker = App.findWorkerById(id);
      // If no worker found, use mock for demo and skip redirect
      if (!worker) { worker = { ...MOCK_WORKER }; }

      document.getElementById('pid').textContent = worker.healthId;
      document.getElementById('pname').textContent = worker.name;
      document.getElementById('pmeta').textContent = `${worker.gender}, ${worker.age} • ${worker.homeState} • ${(worker.currentLocation?.district)||'Kerala'}`;
      QR.render('qr', worker.healthId, 120);

      // status badge + last visit
      (function(){
        const last = (worker.records||[]).slice().sort((a,b)=>(b.date||'').localeCompare(a.date||''))[0];
        document.getElementById('lastVisit').textContent = last ? last.date : '—';
        const status = worker.status || 'Stable';
        const badge = document.getElementById('statusBadge');
        badge.textContent = status;
        badge.className = 'badge ' + (status==='Critical' ? 'bg-danger' : status==='Stable' ? 'bg-success' : 'bg-secondary');
        if (worker.nextAppointment) {
          document.getElementById('nextAppt').textContent = `${worker.nextAppointment.date} ${worker.nextAppointment.time||''}`;
          document.getElementById('nextApptWrap').style.display = '';
        }
      })();

      function renderTimeline() {
        Provider.displayTimelineRecords('recordsTimeline', worker.records||[]);
      }

      function renderHistory() {
        const container = document.getElementById('historyList');
        container.innerHTML = '';
        const hist = worker.history || [];
        if (hist.length === 0) { container.innerHTML = '<div class="text-muted">No history</div>'; return; }
        hist.slice().reverse().forEach(h => {
          const el = document.createElement('div');
          el.className = 'border rounded p-2 mb-2';
          el.innerHTML = `<div class="small text-muted">${h.date}</div><div>${h.type}</div><div class="text-muted small">${h.notes}</div>`;
          container.appendChild(el);
        });
      }

      renderTimeline();
      renderHistory();

      // Vaccinations: render list for demo and real data
      function renderVaccinations() {
        const container = document.getElementById('vaccinationsList');
        if (!container) return;
        container.innerHTML = '';
        const list = worker.vaccinations || [];
        if (list.length === 0) { container.innerHTML = '<div class="text-muted">No vaccination records</div>'; return; }
        const group = document.createElement('div');
        group.className = 'list-group';
        list.forEach(v => {
          const row = document.createElement('div');
          row.className = 'list-group-item d-flex justify-content-between align-items-start flex-column flex-md-row gap-1';
          row.innerHTML = `
            <div>
              <div class="fw-semibold">${v.name}</div>
              <div class="text-muted small">Doses: ${v.doses||'-'} • Last: ${v.lastDate||'-'}</div>
            </div>
            <span class="badge bg-success align-self-md-center">Up to date</span>
          `;
          group.appendChild(row);
        });
        container.appendChild(group);
      }

      // Prescriptions: render list items
      function renderPrescriptions() {
        const container = document.getElementById('prescriptionsList');
        if (!container) return;
        container.innerHTML = '';
        const list = worker.prescriptions || [];
        if (list.length === 0) { container.innerHTML = '<div class="text-muted">No prescriptions</div>'; return; }
        const group = document.createElement('div');
        group.className = 'list-group';
        list.forEach(p => {
          const row = document.createElement('div');
          row.className = 'list-group-item';
          row.innerHTML = `
            <div class="d-flex justify-content-between flex-column flex-md-row gap-1">
              <div class="fw-semibold">${p.drug} ${p.strength}</div>
              <div class="text-muted small">${p.date||''}</div>
            </div>
            <div class="small">${p.frequency} for ${p.duration}</div>
            <div class="text-muted small">Reason: ${p.reason||'-'}</div>
          `;
          group.appendChild(row);
        });
        container.appendChild(group);
      }

      // Pre-fill clinical notes textarea for demo
      (function seedNotes(){
        const ta = document.getElementById('clinicalNotes');
        if (ta && worker.clinicalNotes) ta.value = worker.clinicalNotes;
      })();

      // Render demo lists
      renderVaccinations();
      renderPrescriptions();

      // Ensure allergies exist and re-render (already done below as well)
      worker.allergies = Array.isArray(worker.allergies) ? worker.allergies : [];

      // ------------------ Allergies Section ------------------
      // Ensure allergies array exists for the current worker in local state
      worker.allergies = Array.isArray(worker.allergies) ? worker.allergies : [];

      // Map type to a human friendly label and bootstrap color
      const allergyTypeMeta = {
        medication: { label: 'Medication', color: 'danger' },
        food: { label: 'Food', color: 'warning' },
        environmental: { label: 'Environmental', color: 'info' }
      };

      // Render the list of allergies
      function renderAllergies() {
        const container = document.getElementById('allergyList');
        if (!container) return;
        container.innerHTML = '';
        const list = worker.allergies || [];
        if (list.length === 0) {
          container.innerHTML = '<div class="text-muted">No recorded allergies</div>';
          return;
        }
        const ul = document.createElement('div');
        ul.className = 'list-group';
        list.forEach((item, index) => {
          const meta = allergyTypeMeta[item.type] || { label: item.type || 'Other', color: 'secondary' };
          const row = document.createElement('div');
          row.className = 'list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2';
          row.innerHTML = `
            <div>
              <div class="fw-semibold">${item.name || '—'}
                <span class="badge bg-${meta.color} ms-1">${meta.label}</span>
              </div>
              ${item.description ? `<div class="text-muted small">${item.description}</div>` : ''}
            </div>
            <div class="ms-md-3">
              <button type="button" class="btn btn-outline-danger btn-sm" data-action="remove-allergy" data-index="${index}">Remove</button>
            </div>
          `;
          ul.appendChild(row);
        });
        container.appendChild(ul);
      }

      renderAllergies();

      // Handle add allergy form submit
      document.getElementById('allergyForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const form = e.target;
        // Validate required fields similar to other forms
        if (!form.checkValidity()) { form.classList.add('was-validated'); App.showToast('Please complete required fields', 'error'); return; }
        const fd = new FormData(form);
        const name = (fd.get('name')||'').toString().trim();
        const type = (fd.get('type')||'').toString();
        const description = (fd.get('description')||'').toString().trim();
        // Append to local state for current worker
        worker.allergies.push({ name, type, description });
        // Persist to local storage using existing helper
        App.saveWorker(worker);
        // Re-render list immediately
        renderAllergies();
        App.showToast('Allergy added');
        form.reset();
        form.classList.remove('was-validated');
      });

      // Delegate remove action for allergies list
      document.getElementById('allergyList')?.addEventListener('click', (e) => {
        const target = e.target;
        if (!(target instanceof HTMLElement)) return;
        if (target.dataset.action === 'remove-allergy') {
          const idxStr = target.dataset.index || '-1';
          const idx = parseInt(idxStr, 10);
          if (!Number.isNaN(idx) && idx >= 0 && idx < (worker.allergies?.length||0)) {
            // Remove from array and persist
            worker.allergies.splice(idx, 1);
            App.saveWorker(worker);
            renderAllergies();
            App.showToast('Allergy removed');
          }
        }
      });

      // Add Record modal handling
      document.getElementById('addRecordForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) { form.classList.add('was-validated'); App.showToast('Please complete required fields', 'error'); return; }
        const fd = new FormData(form);
        const data = Object.fromEntries(fd.entries());
        Provider.saveEnhancedRecord(worker, data);
        renderTimeline();
        App.showToast('Record added');
        const modal = document.getElementById('recordModal');
        const closeBtn = modal.querySelector('[data-bs-dismiss="modal"]');
        if (closeBtn) closeBtn.click();
        form.reset();
      });

      document.getElementById('exportBtn').addEventListener('click', () => {
        Provider.generateMedicalReport(worker);
      });

      document.getElementById('printBtn').addEventListener('click', () => window.print());

      // quick actions
      document.getElementById('btnSchedule').addEventListener('click', () => {
        const modal = document.getElementById('apptModal');
        if (window.bootstrap) new bootstrap.Modal(modal).show();
      });
      document.getElementById('btnMarkCritical').addEventListener('click', () => {
        worker.status = 'Critical';
        App.saveWorker(worker);
        App.showToast('Marked as Critical');
        document.getElementById('statusBadge').className = 'badge bg-danger';
        document.getElementById('statusBadge').textContent = 'Critical';
      });
      document.getElementById('btnEmergencyContact').addEventListener('click', () => {
        App.showToast('Contacting emergency services…');
      });

      document.getElementById('saveNotes').addEventListener('click', () => {
        const notes = document.getElementById('clinicalNotes').value || '';
        worker.clinicalNotes = notes;
        App.saveWorker(worker);
        App.showToast('Notes saved');
      });
    </script>

    <!-- Add Record Modal -->
    <div class="modal fade" id="recordModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Medical Record</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="addRecordForm" class="needs-validation" novalidate>
            <div class="modal-body">
              <div class="row g-2">
                <div class="col-12 col-md-4">
                  <label class="form-label">Visit Type</label>
                  <select name="visitType" class="form-select" required>
                    <option>Consultation</option>
                    <option>Emergency</option>
                    <option>Follow-up</option>
                    <option>Procedure</option>
                  </select>
                </div>
                <div class="col-6 col-md-4">
                  <label class="form-label">Date</label>
                  <input name="date" type="date" class="form-control" required />
                </div>
                <div class="col-6 col-md-4">
                  <label class="form-label">Time</label>
                  <input name="time" type="time" class="form-control" />
                </div>
              </div>
              <div class="mt-2">
                <label class="form-label">Chief Complaint</label>
                <input name="chiefComplaint" class="form-control" required />
                <div class="invalid-feedback">Required</div>
              </div>
              <div class="vital-signs-grid mt-2">
                <div>
                  <label class="form-label">Blood Pressure</label>
                  <input name="bp" class="form-control" placeholder="120/80" />
                </div>
                <div>
                  <label class="form-label">Temperature</label>
                  <input name="temp" class="form-control" placeholder="98.6°F" />
                </div>
                <div>
                  <label class="form-label">Heart Rate</label>
                  <input name="hr" class="form-control" placeholder="72 bpm" />
                </div>
                <div>
                  <label class="form-label">Weight</label>
                  <input name="weight" class="form-control" placeholder="kg" />
                </div>
              </div>
              <div class="row g-2 mt-2">
                <div class="col-12 col-md-6">
                  <label class="form-label">Diagnosis</label>
                  <input name="diagnosis" class="form-control" required />
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Treatment</label>
                  <input name="treatment" class="form-control" required />
                </div>
              </div>
              <div class="mt-2">
                <label class="form-label">Prescription</label>
                <textarea name="prescription" class="form-control" rows="3"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Save Record</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Schedule Appointment Modal -->
    <div class="modal fade" id="apptModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Schedule Appointment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="apptForm" class="needs-validation" novalidate>
            <div class="modal-body">
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label">Date</label>
                  <input name="date" type="date" class="form-control" required />
                </div>
                <div class="col-6">
                  <label class="form-label">Time</label>
                  <input name="time" type="time" class="form-control" />
                </div>
              </div>
              <div class="mt-2">
                <label class="form-label">Notes</label>
                <input name="notes" class="form-control" />
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      document.getElementById('apptForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) { form.classList.add('was-validated'); App.showToast('Select a date', 'error'); return; }
        const fd = new FormData(form);
        Provider.scheduleAppointment(worker, { date: fd.get('date'), time: fd.get('time'), notes: fd.get('notes') });
        App.showToast('Appointment scheduled');
        document.getElementById('nextAppt').textContent = `${fd.get('date')} ${fd.get('time')||''}`;
        document.getElementById('nextApptWrap').style.display = '';
        const modal = document.getElementById('apptModal');
        const closeBtn = modal.querySelector('[data-bs-dismiss="modal"]');
        if (closeBtn) closeBtn.click();
        form.reset();
      });
    </script>
  </body>
  </html>

