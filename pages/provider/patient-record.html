<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Patient Record</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="../../css/main.css" />
    <link rel="stylesheet" href="../../css/mobile.css" />
  </head>
  <body>
    <div class="container py-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <a href="./dashboard.html" class="text-decoration-none small">&larr; Back</a>
        <div class="d-flex gap-2">
          <button id="printBtn" class="btn btn-outline-secondary btn-sm">Print</button>
          <a href="../../index.html" class="btn btn-warning btn-sm">Logout</a>
        </div>
      </div>
      <div id="profileCard" class="card card-elevated p-3">
        <div class="d-flex flex-column flex-md-row justify-content-between gap-3">
          <div>
            <div class="small text-muted">Health ID</div>
            <div class="h5" id="pid">—</div>
            <div class="fw-bold" id="pname">—</div>
            <div class="text-muted" id="pmeta">—</div>
            <div class="mt-2">
              <span id="statusBadge" class="badge bg-secondary">—</span>
              <span class="small text-muted">Last visit: <span id="lastVisit">—</span></span>
              <span class="small text-muted ms-2" id="nextApptWrap" style="display:none;">Next: <span id="nextAppt">—</span></span>
            </div>
            <div class="mt-2 d-flex gap-2">
              <button id="btnSchedule" class="btn btn-outline-primary btn-sm">Schedule Appointment</button>
              <button id="btnMarkCritical" class="btn btn-outline-primary btn-sm">Mark Critical</button>
              <button id="btnEmergencyContact" class="btn btn-success btn-sm">Contact Emergency</button>
            </div>
          </div>
          <div class="qr-box align-self-center align-self-md-start"><div id="qr"></div></div>
        </div>
      </div>

      <ul class="nav nav-tabs mt-3" id="tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">Overview</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">History</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#vaccinations" type="button" role="tab">Vaccinations</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#prescriptions" type="button" role="tab">Prescriptions</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">Clinical Notes</button>
        </li>
      </ul>

      <div class="tab-content">
        <div id="overview" class="tab-pane fade show active p-3">
          <div class="small text-muted">Recent Records</div>
          <div id="recordsTimeline" class="mt-2"></div>
          <hr />
          <div class="d-grid d-md-flex gap-2">
            <button class="btn btn-success" type="button" data-bs-toggle="modal" data-bs-target="#recordModal">Add Record</button>
            <button class="btn btn-outline-primary" type="button" id="exportBtn">Export</button>
          </div>
        </div>
        <div id="history" class="tab-pane fade p-3">
          <div id="historyList"></div>
        </div>
        <div id="vaccinations" class="tab-pane fade p-3">
          <p class="text-muted">No vaccination records available in demo.</p>
          <div class="small text-muted">Due tracking will appear here when available.</div>
        </div>
        <div id="prescriptions" class="tab-pane fade p-3">
          <p class="text-muted">No prescriptions available in demo.</p>
        </div>
        <div id="notes" class="tab-pane fade p-3">
          <div class="small text-muted">Private Clinical Notes</div>
          <textarea id="clinicalNotes" class="form-control mt-2" rows="5" placeholder="Enter private observations..."></textarea>
          <div class="d-grid d-md-flex gap-2 mt-2">
            <button id="saveNotes" class="btn btn-outline-primary btn-sm" type="button">Save Notes</button>
          </div>
        </div>
      </div>

      <div class="app-toast"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../../js/main.js"></script>
    <script src="../../js/provider.js"></script>
    <script src="../../js/qr-generator.js"></script>
    <script>
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      const worker = App.findWorkerById(id);
      if (!worker) { window.location.href = './dashboard.html'; }

      document.getElementById('pid').textContent = worker.healthId;
      document.getElementById('pname').textContent = worker.name;
      document.getElementById('pmeta').textContent = `${worker.gender}, ${worker.age} • ${worker.homeState} • ${(worker.currentLocation?.district)||'Kerala'}`;
      QR.render('qr', worker.healthId, 120);

      // status badge + last visit
      (function(){
        const last = (worker.records||[]).slice().sort((a,b)=>(b.date||'').localeCompare(a.date||''))[0];
        document.getElementById('lastVisit').textContent = last ? last.date : '—';
        const status = worker.status || 'Stable';
        const badge = document.getElementById('statusBadge');
        badge.textContent = status;
        badge.className = 'badge ' + (status==='Critical' ? 'bg-danger' : status==='Stable' ? 'bg-success' : 'bg-secondary');
        if (worker.nextAppointment) {
          document.getElementById('nextAppt').textContent = `${worker.nextAppointment.date} ${worker.nextAppointment.time||''}`;
          document.getElementById('nextApptWrap').style.display = '';
        }
      })();

      function renderTimeline() {
        Provider.displayTimelineRecords('recordsTimeline', worker.records||[]);
      }

      function renderHistory() {
        const container = document.getElementById('historyList');
        container.innerHTML = '';
        const hist = worker.history || [];
        if (hist.length === 0) { container.innerHTML = '<div class="text-muted">No history</div>'; return; }
        hist.slice().reverse().forEach(h => {
          const el = document.createElement('div');
          el.className = 'border rounded p-2 mb-2';
          el.innerHTML = `<div class="small text-muted">${h.date}</div><div>${h.type}</div><div class="text-muted small">${h.notes}</div>`;
          container.appendChild(el);
        });
      }

      renderTimeline();
      renderHistory();

      // Add Record modal handling
      document.getElementById('addRecordForm')?.addEventListener('submit', (e) => {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) { form.classList.add('was-validated'); App.showToast('Please complete required fields', 'error'); return; }
        const fd = new FormData(form);
        const data = Object.fromEntries(fd.entries());
        Provider.saveEnhancedRecord(worker, data);
        renderTimeline();
        App.showToast('Record added');
        const modal = document.getElementById('recordModal');
        const closeBtn = modal.querySelector('[data-bs-dismiss="modal"]');
        if (closeBtn) closeBtn.click();
        form.reset();
      });

      document.getElementById('exportBtn').addEventListener('click', () => {
        Provider.generateMedicalReport(worker);
      });

      document.getElementById('printBtn').addEventListener('click', () => window.print());

      // quick actions
      document.getElementById('btnSchedule').addEventListener('click', () => {
        const modal = document.getElementById('apptModal');
        if (window.bootstrap) new bootstrap.Modal(modal).show();
      });
      document.getElementById('btnMarkCritical').addEventListener('click', () => {
        worker.status = 'Critical';
        App.saveWorker(worker);
        App.showToast('Marked as Critical');
        document.getElementById('statusBadge').className = 'badge bg-danger';
        document.getElementById('statusBadge').textContent = 'Critical';
      });
      document.getElementById('btnEmergencyContact').addEventListener('click', () => {
        App.showToast('Contacting emergency services…');
      });

      document.getElementById('saveNotes').addEventListener('click', () => {
        const notes = document.getElementById('clinicalNotes').value || '';
        worker.clinicalNotes = notes;
        App.saveWorker(worker);
        App.showToast('Notes saved');
      });
    </script>

    <!-- Add Record Modal -->
    <div class="modal fade" id="recordModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Medical Record</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="addRecordForm" class="needs-validation" novalidate>
            <div class="modal-body">
              <div class="row g-2">
                <div class="col-12 col-md-4">
                  <label class="form-label">Visit Type</label>
                  <select name="visitType" class="form-select" required>
                    <option>Consultation</option>
                    <option>Emergency</option>
                    <option>Follow-up</option>
                    <option>Procedure</option>
                  </select>
                </div>
                <div class="col-6 col-md-4">
                  <label class="form-label">Date</label>
                  <input name="date" type="date" class="form-control" required />
                </div>
                <div class="col-6 col-md-4">
                  <label class="form-label">Time</label>
                  <input name="time" type="time" class="form-control" />
                </div>
              </div>
              <div class="mt-2">
                <label class="form-label">Chief Complaint</label>
                <input name="chiefComplaint" class="form-control" required />
                <div class="invalid-feedback">Required</div>
              </div>
              <div class="vital-signs-grid mt-2">
                <div>
                  <label class="form-label">Blood Pressure</label>
                  <input name="bp" class="form-control" placeholder="120/80" />
                </div>
                <div>
                  <label class="form-label">Temperature</label>
                  <input name="temp" class="form-control" placeholder="98.6°F" />
                </div>
                <div>
                  <label class="form-label">Heart Rate</label>
                  <input name="hr" class="form-control" placeholder="72 bpm" />
                </div>
                <div>
                  <label class="form-label">Weight</label>
                  <input name="weight" class="form-control" placeholder="kg" />
                </div>
              </div>
              <div class="row g-2 mt-2">
                <div class="col-12 col-md-6">
                  <label class="form-label">Diagnosis</label>
                  <input name="diagnosis" class="form-control" required />
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label">Treatment</label>
                  <input name="treatment" class="form-control" required />
                </div>
              </div>
              <div class="mt-2">
                <label class="form-label">Prescription</label>
                <textarea name="prescription" class="form-control" rows="3"></textarea>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Save Record</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Schedule Appointment Modal -->
    <div class="modal fade" id="apptModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Schedule Appointment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <form id="apptForm" class="needs-validation" novalidate>
            <div class="modal-body">
              <div class="row g-2">
                <div class="col-6">
                  <label class="form-label">Date</label>
                  <input name="date" type="date" class="form-control" required />
                </div>
                <div class="col-6">
                  <label class="form-label">Time</label>
                  <input name="time" type="time" class="form-control" />
                </div>
              </div>
              <div class="mt-2">
                <label class="form-label">Notes</label>
                <input name="notes" class="form-control" />
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-success">Save</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script>
      document.getElementById('apptForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const form = e.target;
        if (!form.checkValidity()) { form.classList.add('was-validated'); App.showToast('Select a date', 'error'); return; }
        const fd = new FormData(form);
        Provider.scheduleAppointment(worker, { date: fd.get('date'), time: fd.get('time'), notes: fd.get('notes') });
        App.showToast('Appointment scheduled');
        document.getElementById('nextAppt').textContent = `${fd.get('date')} ${fd.get('time')||''}`;
        document.getElementById('nextApptWrap').style.display = '';
        const modal = document.getElementById('apptModal');
        const closeBtn = modal.querySelector('[data-bs-dismiss="modal"]');
        if (closeBtn) closeBtn.click();
        form.reset();
      });
    </script>
  </body>
  </html>

